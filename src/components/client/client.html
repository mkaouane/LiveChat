<html>

<head>
  <title>LiveChat</title>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"
    integrity="sha384-Gr6Lu2Ajx28mzwyVR8CFkULdCU7kMlZ9UthllibdOSo6qAiN+yXNHqtgdTvFXMT4"
    crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css" />
  <link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css" />
  <link rel="icon" href="https://lh3.googleusercontent.com/ImL14-58om9oVvXSu84BBy9kcLP7-8RMOuv4MdzfMh1k2SizYcuLfjEEWfbyUoOdI6pfmgCT8gCvfgkF2rlM9lgx7Q=s60" />

  <script src="https://cdn.vidstack.io/player" type="module"></script>
</head>

<body>
  <div class="absolute top-3 left-3 hidden flex-col items-center z-50" id="author-block">
    <div class="w-fit">
      <div class="border-4 rounded-full border-[#57F287] inline-block">
        <img id="author-img" src="" class="w-full h-full max-w-[70px] max-h-[70px] rounded-full" />
      </div>
    </div>
    <div>
      <p id="author-username" class="text-center font-medium text-white text-lg max-w-[100px]"
        style="text-shadow: #57F287 1px 0 10px;"></p>
    </div>
  </div>

  <div class="absolute w-screen h-screen flex items-end justify-center top-0 left-0 z-20 px-5 pb-5">
    <div>
      <p id="message-text" class="text-white text-5xl font-medium text-center" style="text-shadow:white 1px 0 10px;">
      </p>
    </div>
  </div>

  <div class="absolute max-w-screen max-h-screen h-full w-full flex items-center justify-center top-0 left-0">
    <div id="message-block">
    </div>
  </div>

  <script>
    function generateImg(src, displayFull) {
      return '<img id="message-img" ' + (displayFull ? 'class="aspect-auto w-full h-full max-w-[100vw] max-h-[100vh]"' : '') + ' src="' + src + '" />';
    }


    function generateAudioVideo(src, displayFull) {
  console.log('🎬 generateAudioVideo called with:', { src, displayFull });
  
  // Détecter si c'est une URL YouTube
  const isYouTube = src.includes('youtube.com') || src.includes('youtu.be');
  console.log('🔍 Is YouTube URL:', isYouTube);
  
  if (isYouTube) {
    // Extraire l'ID vidéo et le timecode
    const videoId = extractYouTubeId(src);
    const timecode = extractYouTubeTimecode(src);
    console.log('📺 Video ID:', videoId);
    console.log('⏰ Timecode:', timecode);
    
    // Utiliser une iframe YouTube simple avec timecode
    const embedUrl = `https://www.youtube.com/embed/${videoId}?start=${timecode || 0}&autoplay=1&mute=0&controls=1&rel=0`;
    console.log('🔗 Embed URL:', embedUrl);
    
    const baseClasses = "w-full h-auto max-h-[80vh]";
    const fullClasses = "aspect-auto w-[100vw] h-[100vh]";
    
    return '<iframe ' + 
      'class="' + (displayFull ? fullClasses : baseClasses) + '" ' +
      'src="' + embedUrl + '" ' +
      'frameborder="0" allowfullscreen>' +
      '</iframe>';
  }
  
  // Pour les autres médias (fichiers directs)
  return (
  '<media-player id="message-player" ' +
    (displayFull
      ? "class='aspect-auto w-[100vw] h-[100vh]'"
      : "class='w-full h-auto max-h-[80vh]'") +
    ' style="position:absolute; left:-9999px; top:0;" ' + // 👈 caché hors écran
    ' src="' + src + '" autoplay controls>' +
      '<media-provider></media-provider>' +
      '<media-audio-layout></media-audio-layout>' +
      '<media-video-layout></media-video-layout>' +
  '</media-player>'
);

}

    function extractYouTubeId(url) {
      const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }

    function extractYouTubeTimecode(url) {
      console.log('🔍 Extracting timecode from URL:', url);
      
      // Extraire le timecode de différentes formats :
      // ?t=20s, ?t=1m20s, ?t=120, &t=20s, etc.
      const timecodeMatch = url.match(/[?&]t=([^&]+)/);
      console.log('🎯 Timecode match:', timecodeMatch);
      
      if (!timecodeMatch) return null;
      
      const timecode = timecodeMatch[1];
      console.log('⏰ Raw timecode:', timecode);
      
      // Si c'est déjà en secondes (nombre pur)
      if (/^\d+$/.test(timecode)) {
        const seconds = parseInt(timecode);
        console.log('✅ Parsed as seconds:', seconds);
        return seconds;
      }
      
      // Si c'est au format "20s", "1m20s", etc.
      let totalSeconds = 0;
      
      // Extraire les minutes (1m, 2m, etc.)
      const minutesMatch = timecode.match(/(\d+)m/);
      if (minutesMatch) {
        totalSeconds += parseInt(minutesMatch[1]) * 60;
        console.log('📅 Minutes found:', minutesMatch[1]);
      }
      
      // Extraire les secondes (20s, 30s, etc.)
      const secondsMatch = timecode.match(/(\d+)s/);
      if (secondsMatch) {
        totalSeconds += parseInt(secondsMatch[1]);
        console.log('⏱️ Seconds found:', secondsMatch[1]);
      }
      
      // Si pas de format reconnu, essayer de parser comme nombre
      if (totalSeconds === 0 && /^\d+/.test(timecode)) {
        totalSeconds = parseInt(timecode);
        console.log('🔢 Parsed as number:', totalSeconds);
      }
      
      console.log('🎬 Final timecode in seconds:', totalSeconds);
      return totalSeconds > 0 ? totalSeconds : null;
    }

    function displayAuthor(authorUsername, authorPictureURL) {
      var elementBlock = document.getElementById('author-block');
      var elementUsername = document.getElementById('author-username');
      var elementImg = document.getElementById('author-img');

      elementBlock.style.display = 'none';

      elementUsername.innerHTML = authorUsername;
      // Display default image if user doesn't have an image
      elementImg.src = authorPictureURL || 'https://archive.org/download/discordprofilepictures/discordblue.png';

      if (authorUsername || authorPictureURL) {
        elementBlock.style.display = 'flex';
      }
    }

    function displayText(text) {
      var element = document.getElementById('message-text');
      element.style.display = 'none';

      if (text) {
        element.innerHTML = text;
        element.style.display = 'block';
      }
    }


    function displayContent(data) {
  var element = document.getElementById('message-block');

  element.innerHTML = '';

  console.log('🔍 displayContent appelée avec:', data);

  if (data.mediaContentType) {
    console.log('🎬 Displaying media:', {
      contentType: data.mediaContentType,
      url: data.media || data.url,
      displayFull: data.displayFull
    });
    
    if (data.mediaContentType.indexOf('image') === 0) {
      console.log('🖼️ Image détectée, génération de l\'image avec son...');
      console.log('🖼️ URL de l\'image:', data.media || data.url);
      console.log('🖼️ Type de contenu:', data.mediaContentType);
      
      // Créer le media-player AVANT l'image (comme les MP3)
      console.log('🎵 Création du media-player AVANT l\'image...');
      // Utiliser le même système que generateAudioVideo mais avec l'URL du son
      const soundUrl = 'https://cdn.discordapp.com/attachments/1272978110568071244/1431710189161156668/Bruit_de_pet_qui_resonne.mp3?ex=68fe6784&is=68fd1604&hm=21b722e07193cbdf9bd91b58bb37e03507a6fb4c23f93e4d7542ad8610f65524&';
      const soundHtml = generateAudioVideo(soundUrl, data.displayFull);
      
      // Créer l'image
      const imageHtml = generateImg(data.media || data.url, data.displayFull);
      
      // Ajouter le player AVANT l'image (comme les MP3)
      element.innerHTML = soundHtml + imageHtml;
      
      console.log('🎮 Media player HTML ajouté');
      
      // Ajouter des logs pour comparer avec les MP3
      setTimeout(() => {
        const player = document.getElementById('message-player');
        if (player) {
          console.log('🎮 Media player IMAGE créé:', player);
          console.log('🔗 Player src IMAGE:', player.src);
          console.log('🎮 Player autoplay:', player.hasAttribute('autoplay'));
          console.log('🎮 Player controls:', player.hasAttribute('controls'));
          console.log('🎮 Player class:', player.className);
          
          player.addEventListener('loadstart', () => console.log('📡 IMAGE: Load started'));
          player.addEventListener('canplay', () => console.log('▶️ IMAGE: Can play'));
          player.addEventListener('play', () => console.log('🎵 IMAGE: En cours de lecture !'));
          player.addEventListener('playing', () => console.log('🎵 IMAGE: Joué avec succès !'));
          player.addEventListener('error', (e) => console.log('❌ IMAGE: Player error:', e));
        }
      }, 100);
      
      // Pas de JavaScript - laisser l'autoplay naturel fonctionner (comme les MP3)
      console.log('🎵 Media player créé avec autoplay naturel');
    } else {
      console.log('🎬 Media non-image détecté (MP3/VIDEO)');
      console.log('🎬 URL du média:', data.media || data.url);
      console.log('🎬 Type de contenu:', data.mediaContentType);
      element.innerHTML = generateAudioVideo(data.media || data.url, data.displayFull);
      
      // Ajouter un listener pour déboguer
      setTimeout(() => {
        const player = document.getElementById('message-player');
        if (player) {
          console.log('🎮 Media player MP3/VIDEO créé:', player);
          console.log('🔗 Player src MP3/VIDEO:', player.src);
          console.log('🎮 Player autoplay:', player.hasAttribute('autoplay'));
          console.log('🎮 Player controls:', player.hasAttribute('controls'));
          console.log('🎮 Player class:', player.className);
          
          player.addEventListener('loadstart', () => console.log('📡 MP3/VIDEO: Load started'));
          player.addEventListener('canplay', () => console.log('▶️ MP3/VIDEO: Can play'));
          player.addEventListener('play', () => console.log('🎵 MP3/VIDEO: En cours de lecture !'));
          player.addEventListener('playing', () => console.log('🎵 MP3/VIDEO: Joué avec succès !'));
          player.addEventListener('error', (e) => console.log('❌ MP3/VIDEO: Player error:', e));
        }
      }, 100);
    }
  } else {
    console.log('❌ Pas de mediaContentType dans les données');
  }
}

    var timeout;
    
    function displayMessage(message) {
      console.log('📨 displayMessage appelée avec:', message);
      
      // Clear any existing timeout
      if (timeout) {
        clearTimeout(timeout);
      }

      var content = JSON.parse(message.content || '{}');
      console.log('📦 Content parsé:', content);
      
      var elementMessage = document.getElementById('message-block');
      var elementBlock = document.getElementById('author-block');
      var elementText = document.getElementById('message-text');
      elementMessage.innerHTML = '';
      elementBlock.style.display = 'none';
      elementText.style.display = 'none';

      displayAuthor(message.author, message.authorImage);
      displayText(content.text);
      displayContent(content);

      // Log the initial message duration
      console.log('Initial message duration:', message.duration);

      // If media is present and duration is specified
      if (message.duration) {
        let displayDuration = message.duration;

        // Try to get the video element
        const mediaPlayer = document.getElementById('message-player');
        if (mediaPlayer) {
          const videoElement = mediaPlayer.querySelector('video');
          
          if (videoElement) {
            // Function to handle video duration
            const handleVideoDuration = () => {
              // If video duration is available and valid
              if (videoElement.duration && videoElement.duration > 0) {
                // Use the shorter of the two durations
                displayDuration = Math.min(message.duration, videoElement.duration);
                
                console.log('Actual video duration:', videoElement.duration);
                console.log('Calculated display duration:', displayDuration);

                // Set timeout based on actual video duration
                timeout = setTimeout(() => {
                  console.log('Removing media after:', displayDuration, 'seconds');
                  displayMessage({});
                }, Math.floor(displayDuration * 1000) + 100);
              }
            };

            // If metadata is already loaded
            if (videoElement.readyState >= 1) {
              handleVideoDuration();
            } else {
              // Wait for metadata to load
              videoElement.addEventListener('loadedmetadata', handleVideoDuration);
            }

            // Fallback timeout if duration is not detected
            setTimeout(() => {
              if (!timeout) {
                console.log('Fallback timeout triggered');
                timeout = setTimeout(() => {
                  displayMessage({});
                }, Math.floor(message.duration * 1000) + 100);
              }
            }, 2000);
          } else {
            // Fallback if no video element found
            console.log('No video element found, using default duration');
            timeout = setTimeout(() => {
              displayMessage({});
            }, Math.floor(message.duration * 1000) + 100);
          }
        } else {
          // Fallback if no media player
          console.log('No media player found, using default duration');
          timeout = setTimeout(() => {
            displayMessage({});
          }, Math.floor(message.duration * 1000) + 100);
        }
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      console.log('🚀 DOM chargé, initialisation du socket...');
      
      var socket = io({
        'reconnection': true,
        'reconnectionDelay': 1000,
        'reconnectionDelayMax': 1000,
        'reconnectionAttempts': 999
      });

      socket.on('connect', () => {
        console.log('🔌 Socket connecté !');
        //Get query param
        const urlParams = new URLSearchParams(window.location.search);
        const guildId = urlParams.get('guildId');
        console.log('🏠 GuildId:', guildId);
        socket.emit("join-room", "messages-" + guildId);
        console.log('📡 Émission join-room: messages-' + guildId);
      });

      socket.on('disconnect', () => {
        console.log('❌ Socket déconnecté !');
      });

      socket.on('connect_error', (error) => {
        console.log('❌ Erreur de connexion socket:', error);
      });

      socket.on("new-message", function (data) {
        console.log('📨 NOUVEAU MESSAGE REÇU:', data);
        console.debug(data);
        displayMessage(data);
      });

      socket.on("stop", function (data) {
        console.log('⏹️ STOP reçu:', data);
        console.debug("Media stopped !");
        clearTimeout(timeout);
        displayMessage({});
      });

      // Log toutes les autres émissions du socket
      socket.onAny((eventName, ...args) => {
        console.log('📡 Socket event:', eventName, args);
      });
    });
  </script>
</body>

</html>